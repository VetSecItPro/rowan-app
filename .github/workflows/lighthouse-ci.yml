name: Lighthouse CI - Mobile Performance

on:
  pull_request:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:

env:
  NODE_OPTIONS: '--max_old_space_size=4096'

jobs:
  lighthouse:
    name: Run Lighthouse Mobile Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          # Use placeholder values for build (auth pages are static)
          NEXT_PUBLIC_SUPABASE_URL: https://example.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder_key_for_build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x

      - name: Run Lighthouse CI
        id: lighthouse
        run: |
          # Start production server in background
          npm run start &

          # Wait for server to be ready
          sleep 10

          # Run Lighthouse CI with mobile settings
          lhci autorun --collect.settings.formFactor=mobile \
            --collect.settings.screenEmulation.mobile=true \
            --collect.settings.screenEmulation.width=375 \
            --collect.settings.screenEmulation.height=667 \
            --collect.settings.screenEmulation.deviceScaleFactor=2 \
            --collect.settings.throttling.rttMs=150 \
            --collect.settings.throttling.throughputKbps=1638 \
            --collect.settings.throttling.cpuSlowdownMultiplier=4 \
            --collect.url=http://localhost:3000/ \
            --collect.url=http://localhost:3000/login \
            --collect.url=http://localhost:3000/signup \
            --collect.numberOfRuns=1 \
            --upload.target=temporary-public-storage || true

          # Kill the server
          pkill -f "next start" || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: https://example.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder_key_for_build

      - name: Generate Lighthouse Report Summary
        if: always()
        run: |
          echo "### ðŸ“± Lighthouse Mobile Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Device Emulation:** iPhone 8 (375x667 @ 2x)" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** Slow 4G (150ms RTT, 1.6Mbps)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if results exist
          if [ -d ".lighthouseci" ]; then
            echo "#### Performance Budgets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Budget | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Performance Score | â‰¥70 | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Accessibility | â‰¥90 | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| First Contentful Paint | <2.5s | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Largest Contentful Paint | <4s | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Blocking Time | <600ms | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Cumulative Layout Shift | <0.25 | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š Full reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Lighthouse results not found (may have timed out)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci
          retention-days: 14

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ðŸ“± Lighthouse Mobile Performance Audit\n\n';
            comment += '| Metric | Target |\n';
            comment += '|--------|--------|\n';
            comment += '| Performance | â‰¥70 |\n';
            comment += '| Accessibility | â‰¥90 |\n';
            comment += '| Best Practices | â‰¥80 |\n';
            comment += '| SEO | â‰¥90 |\n';
            comment += '| LCP | <4s |\n';
            comment += '| CLS | <0.25 |\n\n';
            comment += '*Full report in workflow summary and artifacts*\n\n';
            comment += 'ðŸ“² **Tested on:** iPhone 8 emulation (375x667, Slow 4G)';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  # Optional: Bundle size check
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze bundle
        run: |
          npm run build

          echo "### ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find JS chunks
          if [ -d ".next/static/chunks" ]; then
            echo "#### JavaScript Chunks" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find .next/static/chunks -name "*.js" -type f -exec du -h {} \; | sort -rh | head -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Calculate total JS size
            TOTAL_JS=$(find .next/static/chunks -name "*.js" -type f -exec cat {} \; | wc -c)
            TOTAL_JS_KB=$((TOTAL_JS / 1024))
            echo "**Total JS:** ${TOTAL_JS_KB}KB" >> $GITHUB_STEP_SUMMARY

            # Warn if over budget
            if [ $TOTAL_JS_KB -gt 500 ]; then
              echo "âš ï¸ **Warning:** JS bundle exceeds 500KB mobile budget" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… JS bundle within mobile budget (<500KB)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://example.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder_key_for_build
