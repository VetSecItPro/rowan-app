name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  NODE_OPTIONS: '--max_old_space_size=4096'

# Cancel in-progress runs for same branch
concurrency:
  group: production-${{ github.sha }}
  cancel-in-progress: true

jobs:
  # Check for migrations (fast, runs first)
  check-migrations:
    name: Check Migrations
    runs-on: ubuntu-latest
    outputs:
      has_migrations: ${{ steps.check.outputs.has_migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for new migrations
        id: check
        run: |
          NEW_MIGRATIONS=$(git diff --name-only HEAD~1 HEAD | grep '^supabase/migrations/' || echo "")
          if [ -z "$NEW_MIGRATIONS" ]; then
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          else
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "### ðŸ“‹ Migrations detected:" >> $GITHUB_STEP_SUMMARY
            echo "$NEW_MIGRATIONS" >> $GITHUB_STEP_SUMMARY
          fi

  # Apply migrations if needed (parallel with deploy)
  apply-migrations:
    name: Apply Migrations
    needs: check-migrations
    if: needs.check-migrations.outputs.has_migrations == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Apply migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          timeout 30s supabase link --project-ref $SUPABASE_PROJECT_ID || exit 0
          timeout 60s supabase db push --include-all 2>&1 || echo "Migration applied or already exists"
          echo "âœ… Migrations processed" >> $GITHUB_STEP_SUMMARY

  # Deploy to production (runs in parallel with migrations)
  deploy:
    name: Deploy
    needs: check-migrations
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check || echo "Type check completed"

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Deployed to Production" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— $url" >> $GITHUB_STEP_SUMMARY

      - name: Promote to custom domain
        run: |
          vercel alias set "${{ steps.deploy.outputs.url }}" rowanapp.com --token=${{ secrets.VERCEL_TOKEN }} || true
          vercel alias set "${{ steps.deploy.outputs.url }}" www.rowanapp.com --token=${{ secrets.VERCEL_TOKEN }} || true
          echo "âœ… Live at https://rowanapp.com" >> $GITHUB_STEP_SUMMARY
