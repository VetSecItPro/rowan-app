name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  NODE_OPTIONS: '--max_old_space_size=8192'
  NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder' }}
  NEXT_PUBLIC_ENABLE_MONETIZATION: 'true'

jobs:
  # ─── Fast quality gate (lint + typecheck) ───
  quality:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Lint
        run: pnpm lint
        continue-on-error: true
      - run: pnpm type-check

  # ─── Security scanning ───
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      - name: Dependency audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Secret pattern scan
        run: |
          echo "Scanning for leaked secrets in source..."
          PATTERNS='sk_live_|sk_test_|AKIA[0-9A-Z]{16}|-----BEGIN (RSA |EC )?PRIVATE KEY|ghp_[a-zA-Z0-9]{36}|glpat-[a-zA-Z0-9\-]{20}'
          MATCHES=$(grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" -E "$PATTERNS" . \
            --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git || true)
          if [ -n "$MATCHES" ]; then
            echo "::error::Potential secrets found in source code!"
            echo "$MATCHES"
            exit 1
          fi
          echo "No secrets detected."

      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/nextjs
        continue-on-error: true

  # ─── Production build + bundle analysis ───
  build:
    name: Build & Bundle Size
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      - name: Bundle size report
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo '| File | Size |' >> $GITHUB_STEP_SUMMARY
          echo '|------|------|' >> $GITHUB_STEP_SUMMARY

          WARN=0
          FAIL=0

          for f in $(find .next/static/chunks -name "*.js" -type f 2>/dev/null | sort); do
            SIZE=$(stat -c%s "$f" 2>/dev/null || echo "0")
            SIZE_KB=$((SIZE / 1024))
            NAME=$(basename "$f")

            if [ "$SIZE_KB" -gt 750 ]; then
              echo "| \`$NAME\` | **${SIZE_KB}KB** :x: |" >> $GITHUB_STEP_SUMMARY
              FAIL=$((FAIL + 1))
            elif [ "$SIZE_KB" -gt 500 ]; then
              echo "| \`$NAME\` | **${SIZE_KB}KB** :warning: |" >> $GITHUB_STEP_SUMMARY
              WARN=$((WARN + 1))
            elif [ "$SIZE_KB" -gt 200 ]; then
              echo "| \`$NAME\` | ${SIZE_KB}KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Chunks > 500KB: $WARN warnings, $FAIL failures" >> $GITHUB_STEP_SUMMARY

          if [ "$FAIL" -gt 0 ]; then
            echo "::warning::$FAIL chunk(s) exceed 750KB — review before launch"
          fi

  # ─── E2E tests (Playwright starts its own dev server) ───
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    env:
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
      SMOKE_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright Chromium
        run: pnpm exec playwright install chromium --with-deps

      - name: Run E2E tests
        run: pnpm test:e2e:chromium

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ─── Lighthouse (builds and starts prod server) ───
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      - name: Start server
        run: pnpm start &

      - name: Wait for server
        run: npx wait-on http://localhost:3000 --timeout 30000

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ─── Summary (always runs) ───
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, security, build, e2e, lighthouse]
    if: always()
    steps:
      - name: Evaluate results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo '| Job | Status |' >> $GITHUB_STEP_SUMMARY
          echo '|-----|--------|' >> $GITHUB_STEP_SUMMARY

          FAILED=0

          check_job() {
            local name="$1"
            local result="$2"
            if [ "$result" = "success" ]; then
              echo "| $name | :white_check_mark: passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "$result" = "skipped" ]; then
              echo "| $name | :fast_forward: skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $name | :x: $result |" >> $GITHUB_STEP_SUMMARY
              FAILED=$((FAILED + 1))
            fi
          }

          check_job "Quality" "${{ needs.quality.result }}"
          check_job "Security" "${{ needs.security.result }}"
          check_job "Build & Bundle" "${{ needs.build.result }}"
          check_job "E2E Tests" "${{ needs.e2e.result }}"
          check_job "Lighthouse" "${{ needs.lighthouse.result }}"

          if [ "$FAILED" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":x: **$FAILED job(s) failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":white_check_mark: **All checks passed**" >> $GITHUB_STEP_SUMMARY
