# Test Audit Report — Rowan App

**Date**: 2026-02-07
**Commit**: `3c0fca2d` on `main`
**Pipeline**: `/test-ship` Full Audit

---

## Phase 0: Baseline

| Metric | Value |
|--------|-------|
| Unit test files | 3 (`__tests__/ai/`) |
| Unit tests | 96 (all passing) |
| E2E test files | 4 (`tests/e2e/`) |
| E2E tests (active) | ~15 (many skipped — require test user setup) |
| Test framework (unit) | Vitest 4.0.18 |
| Test framework (E2E) | Playwright 1.58.0 |
| Package manager | pnpm |
| vitest config | `__tests__/**/*.test.ts`, environment: node |
| playwright config | `tests/e2e/`, chromium + mobile-chrome |

### Baseline Assessment

**Strengths:**
- AI module well tested (tool-definitions, tool-executor, chat-orchestrator)
- Security-focused tests (space_id injection, error masking)
- E2E framework with helpers for auth, monetization flows

**Gaps Identified:**
- Zero unit tests for 20+ service files (`lib/services/`)
- Zero unit tests for API routes (`app/api/`)
- Zero unit tests for utility modules (`lib/`)
- Most E2E tests are skipped (require test user infra)
- No middleware tests (CSRF, rate limiting, auth)
- No sanitization tests (`lib/sanitize.ts`)
- No validation schema tests (Zod schemas in routes)

---

## Phase 1: Audit Findings — Prioritized Test Targets

### CRITICAL — Security-Sensitive Pure Functions (Zero Tests)

| Module | Functions | Risk |
|--------|-----------|------|
| `lib/sanitize.ts` | `sanitizePlainText`, `sanitizeHtml`, `sanitizeUrl` | XSS prevention — called by every API route that handles user text |
| `lib/security/csrf.ts` | `generateCsrfToken`, `validateCsrfToken`, `requiresCsrfProtection`, `isCsrfExempt` | CSRF protection — guards all state-changing API requests |
| `lib/ratelimit-fallback.ts` | `extractIP`, `fallbackRateLimit`, `isValidIP` | Rate limiting + IP spoofing defense — fallback when Redis is down |
| `lib/utils/input-sanitization.ts` | `sanitizeSearchInput`, `sanitizeSearchInputStrict`, `isValidSearchQuery` | SQL injection (LIKE wildcards) + ReDoS prevention |

### HIGH — Business Logic Pure Functions (Zero Tests)

| Module | Functions | Risk |
|--------|-----------|------|
| `lib/utils/ingredient-simplifier.ts` | `simplifyIngredient`, `simplifyIngredients` | Recipe-to-shopping-list conversion — complex string parsing |
| `lib/utils/format.ts` | `formatBytes` | Utility — simple but used in data export UI |

### MEDIUM — Integration Targets (Deferred)

| Module | Why Deferred |
|--------|-------------|
| `lib/services/*.ts` (20+ files) | All require Supabase mocking — high effort, lower ROI than pure function tests |
| `app/api/**` (30+ routes) | Require full Next.js request context mocking — integration test territory |
| `middleware.ts` | Complex middleware requires `NextRequest` mocking with cookie/header simulation |

### LOW — E2E Infrastructure

| Issue | Status |
|-------|--------|
| 12+ skipped tests in E2E suite | Require test user provisioning in Supabase — infrastructure work |
| Flaky selectors (`waitForTimeout`) | Present in `checkout-flow.spec.ts` — should use `waitForSelector` |

---

## Phase 2: Implementation — 6 New Test Files (101 Tests)

### Files Created

| File | Tests | Coverage Target |
|------|-------|----------------|
| `__tests__/lib/sanitize.test.ts` | 26 | XSS: plain text stripping, HTML sanitization, URL protocol blocking |
| `__tests__/lib/security/csrf.test.ts` | 16 | Token generation entropy, method protection, route exemptions |
| `__tests__/lib/ratelimit-fallback.test.ts` | 17 | IP extraction priority chain, spoofing defense, rate limit windowing |
| `__tests__/lib/utils/input-sanitization.test.ts` | 18 | SQL wildcard escaping, length limits, ReDoS prevention |
| `__tests__/lib/utils/ingredient-simplifier.test.ts` | 16 | Quantity/unit/descriptor stripping, dedup, object/string formats |
| `__tests__/lib/utils/format.test.ts` | 8 | Byte formatting edge cases |

### Test Categories

| Category | Tests Added |
|----------|-------------|
| Security (XSS/CSRF/Rate Limit) | 61 |
| Input Validation (SQL/ReDoS) | 18 |
| Business Logic | 16 |
| Utility | 8 |
| **Total New** | **101** |

---

## Phase 3: Verification

### Unit Tests

```
 Test Files  9 passed (9)
      Tests  197 passed (197)
   Start at  07:01:51
   Duration  4.20s
```

| Metric | Before | After | Delta |
|--------|--------|-------|-------|
| Test files | 3 | 9 | +6 |
| Tests | 96 | 197 | +101 (+105%) |
| All passing | Yes | Yes | -- |

### TypeScript

```
pnpm type-check → 0 errors
```

### Production Build

```
pnpm build → success (no errors)
```

---

## Remaining Test Debt (Future Work)

| Priority | Area | Effort | Tests Needed |
|----------|------|--------|-------------|
| HIGH | Service layer mocking (`lib/services/`) | Large | ~200+ |
| HIGH | E2E test user infrastructure | Medium | Unblocks 12+ skipped tests |
| MEDIUM | API route integration tests | Large | ~100+ |
| MEDIUM | Middleware unit tests (CSRF validation, body size) | Medium | ~20 |
| LOW | React component tests (hooks, UI) | Large | ~50+ |
| LOW | Date utility tests (`lib/utils/date-utils.ts`) | Small | ~15 |
