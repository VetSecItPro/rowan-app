# Production Audit Report

**Date:** 2026-02-01 23:50 UTC
**Project:** rowan-app (Next.js 15.4.10, Supabase, Vercel)
**Audited by:** Claude Production Audit (4-domain sweep)
**Domains:** Security | Database | Performance | Frontend/UX

---

## Executive Summary

| Severity | Count |
|----------|-------|
| CRITICAL | 4 |
| HIGH | 17 |
| MEDIUM | 20 |
| LOW | 14 |
| INFO | 13 |
| **Total** | **68** |

**Overall Risk Level:** HIGH (Critical CVE + auth gaps)

---

## Domain Breakdown

| Domain | Critical | High | Medium | Low | Info |
|--------|----------|------|--------|-----|------|
| Security | 2 | 5 | 7 | 5 | 4 |
| Database | 2 | 3 | 5 | 2 | 3 |
| Performance | 0 | 7 | 14 | 5 | 6 |
| Frontend/UX | 0 | 5 | 6 | 7 | 5 |

---

## CRITICAL

### FIX-001: Next.js HTTP request deserialization DoS (CVE-2026-23864)
- **Domain:** Security (SEC-001)
- **File:** `package.json`
- **Description:** Next.js 15.4.10 vulnerable to CVSS 7.5 DoS via App Router Server Function deserialization
- **Remediation:** `npm update next@15.4.11`

### FIX-002: Duplicate ADMIN_SESSION_SECRET with conflicting values
- **Domain:** Security (SEC-002)
- **File:** `.env.local:48,84`
- **Description:** ADMIN_SESSION_SECRET defined twice with different values. Line 84 overrides line 48.
- **Remediation:** Remove duplicate on line 84

### FIX-003: RLS disabled on spatial_ref_sys table
- **Domain:** Database (DB-001)
- **Table:** `spatial_ref_sys`
- **Description:** PostGIS reference table accessible via API without RLS
- **Remediation:** `ALTER TABLE public.spatial_ref_sys ENABLE ROW LEVEL SECURITY;`

### FIX-004: SECURITY DEFINER function without search_path
- **Domain:** Database (DB-002)
- **Function:** `get_dashboard_summary`
- **Description:** Privilege escalation risk via search_path hijacking
- **Remediation:** `ALTER FUNCTION public.get_dashboard_summary() SET search_path = public;`

---

## HIGH

### FIX-005: Next.js Image Optimizer OOM (CVE-2025-59471)
- **Domain:** Security (SEC-003)
- **Description:** Unbounded memory via image optimization with remotePatterns. CVSS 5.9.
- **Remediation:** Upgrade Next.js to >= 15.5.10

### FIX-006: CSP uses unsafe-inline and unsafe-eval in production
- **Domain:** Security (SEC-005)
- **File:** `middleware.ts:462`, `next.config.mjs:138`
- **Description:** Weakens XSS protection. Required by Next.js framework limitations.
- **Remediation:** Implement nonce-based CSP when Next.js support stabilizes

### FIX-007: Data export routes use general rate limit (10/10s) instead of expensive operation limit
- **Domain:** Security (SEC-006)
- **Files:** `app/api/user/export-data/route.ts`, `export-data-csv`, `export-data-pdf`, `privacy/generate-export`
- **Remediation:** Switch to `checkExpensiveOperationRateLimit`

### FIX-008: getSession() used instead of getUser() in privacy/preferences
- **Domain:** Security (SEC-007)
- **File:** `app/api/privacy/preferences/route.ts:283,346`
- **Remediation:** Replace getSession() with getUser() in helper functions

### FIX-009: Nullable space_id on 12 core tables (RLS bypass risk)
- **Domain:** Database (DB-003)
- **Tables:** tasks, events, reminders, messages, shopping_lists, recipes, meal_plans, expenses, goals, daily_checkins, chores, conversations
- **Remediation:** Add NOT NULL constraints after verifying no existing NULLs

### FIX-010: 472 RLS policies use auth.uid() without (SELECT) wrapper
- **Domain:** Database (DB-004)
- **Description:** Per-row function evaluation instead of once-per-query
- **Remediation:** Batch rewrite policies to use `(SELECT auth.uid())`

### FIX-011: PostGIS extension in public schema
- **Domain:** Database (DB-005)
- **Description:** Hundreds of functions exposed via PostgREST API
- **Remediation:** Move PostGIS to extensions schema (post-launch)

### FIX-012: Location page 495kB, Dashboard 467kB, Calendar 453kB First Load JS
- **Domain:** Performance (PERF-001/002/003)
- **Remediation:** Dynamic import heavy sub-components (map, calendar views, activity feed)

### FIX-013: 122kB shared chunk loaded on every page
- **Domain:** Performance (PERF-005)
- **Remediation:** Run ANALYZE=true build, identify tree-shaking opportunities

### FIX-014: 280 `.select('*')` with only 20% having `.limit()`
- **Domain:** Performance (PERF-010)
- **Remediation:** Systematic column selection and pagination

### FIX-015: No maxDuration on any cron or webhook routes
- **Domain:** Performance (PERF-020)
- **Files:** All 8 cron routes + webhook route
- **Remediation:** Add `export const maxDuration = 60;`

### FIX-016: Middleware makes getUser() DB call on every request (50-200ms)
- **Domain:** Performance (PERF-029)
- **File:** `middleware.ts:125`
- **Remediation:** Use getSession() for most routes, getUser() only for sensitive ops

### FIX-017: N+1 query in getTagSpendingAnalysis
- **Domain:** Performance (PERF-023)
- **File:** `lib/services/categories-tags-service.ts:516`
- **Remediation:** Single query with join instead of N individual queries

### FIX-018: Missing robots.txt
- **Domain:** Frontend (FE-001)
- **Remediation:** Create `app/robots.ts`

### FIX-019: Missing metadataBase in root layout
- **Domain:** Frontend (FE-002)
- **File:** `app/layout.tsx:34`
- **Remediation:** Add `metadataBase: new URL('https://rowanapp.com')`

### FIX-020: Service worker references non-existent icon files
- **Domain:** Frontend (FE-015)
- **File:** `public/sw.js:18`
- **Remediation:** Create missing icons or update paths

### FIX-021: Multiple authenticated routes not protected by middleware
- **Domain:** Frontend (FE-018)
- **File:** `middleware.ts:309`
- **Routes:** /expenses, /budget, /budget-setup, /location, /rewards, /achievements, /year-in-review, /reports
- **Remediation:** Add to protectedPaths and matcher config

---

## MEDIUM

### FIX-022: @babel/runtime ReDoS (CVE-2025-27789)
- **Domain:** Security (SEC-008)
- **Remediation:** Override @babel/runtime to >= 7.26.10

### FIX-023: 84 of 163 API routes lack Zod validation
- **Domain:** Security (SEC-009)
- **Remediation:** Add Zod schemas to POST/PUT/PATCH routes

### FIX-024: 1-year session cookie duration
- **Domain:** Security (SEC-010)
- **File:** `middleware.ts:28`
- **Remediation:** Reduce to 30-90 days

### FIX-025: Math.random() for mock budget similarity
- **Domain:** Security (SEC-011)
- **File:** `app/(main)/budget/recurring/page.tsx:242`
- **Remediation:** Implement real calculation or hide feature

### FIX-026: CSP mismatch between middleware and next.config
- **Domain:** Security (SEC-012)
- **Remediation:** Consolidate to single location (middleware)

### FIX-027: Admin health endpoint returns mock data
- **Domain:** Security (SEC-013)
- **File:** `app/api/admin/health/route.ts:202`
- **Remediation:** Implement real metrics or label as placeholder

### FIX-028: Geolocation route uses less-trusted IP extraction
- **Domain:** Security (SEC-014)
- **File:** `app/api/geolocation/route.ts:69`
- **Remediation:** Use extractIP() consistently

### FIX-029: 34 text columns missing CHECK constraints
- **Domain:** Database (DB-006)
- **Priority:** admin_users.role, space_members.role, tasks.status
- **Remediation:** Add CHECK constraints for valid values

### FIX-030: Multiple permissive UPDATE policies on messages
- **Domain:** Database (DB-007)
- **Remediation:** Review and consolidate UPDATE policies

### FIX-031: 33 tables with updated_at but no auto-update trigger
- **Domain:** Database (DB-008)
- **Remediation:** Create generic trigger function and apply

### FIX-032: Duplicate/overlapping table structures
- **Domain:** Database (DB-009)
- **Tables:** activity_log/activity_logs/activity_feed, check_in_reactions/checkin_reactions, notifications variants
- **Remediation:** Audit usage, merge duplicates

### FIX-033: 395 unused indexes
- **Domain:** Database (DB-010)
- **Remediation:** Drop confirmed-unused indexes after launch metrics stabilize

### FIX-034: Middleware 129kB (above 50kB recommendation for edge)
- **Domain:** Performance (PERF-006)
- **Remediation:** Audit imports, consider moving CSRF to API routes

### FIX-035: Module-level event listeners in useFeatureTracking never cleaned
- **Domain:** Performance (PERF-007)
- **Remediation:** Add periodic flush timer

### FIX-036: 60+ API route .select('*') without pagination
- **Domain:** Performance (PERF-011)
- **Remediation:** Add pagination to admin routes, select specific columns

### FIX-037: Sequential processing in cron routes
- **Domain:** Performance (PERF-027)
- **Remediation:** Use Promise.allSettled() with concurrency limiter

### FIX-038: Zero React.memo across all components
- **Domain:** Performance (PERF-033)
- **Remediation:** Add to list item components (TaskCard, MessageItem, ExpenseRow)

### FIX-039: N+1 in enhanced-notification-service
- **Domain:** Performance (PERF-024)
- **File:** `lib/services/enhanced-notification-service.ts:131`
- **Remediation:** Batch fetch with .in('id', userIds)

### FIX-040: Sequential await in subtask/photo reordering
- **Domain:** Performance (PERF-025)
- **Remediation:** Promise.all() or single RPC

### FIX-041: Sequential milestone creation from templates
- **Domain:** Performance (PERF-026)
- **File:** `lib/services/goals-service.ts:789`
- **Remediation:** Single .insert([...milestones])

### FIX-042: No OpenGraph image for public pages
- **Domain:** Frontend (FE-003)
- **Remediation:** Create app/opengraph-image.tsx

### FIX-043: ConfirmDialog missing focus trap
- **Domain:** Frontend (FE-006)
- **File:** `components/shared/ConfirmDialog.tsx:62`
- **Remediation:** Reuse Modal focus trap logic

### FIX-044: Malformed CSS gradient on 404 page
- **Domain:** Frontend (FE-009)
- **File:** `app/not-found.tsx:8`
- **Remediation:** Fix duplicate from- class

### FIX-045: global-error.tsx missing lang and dark mode
- **Domain:** Frontend (FE-010)
- **File:** `app/global-error.tsx:18`
- **Remediation:** Add lang="en", dark class, dark styling

### FIX-046: theme_color mismatch manifest vs layout
- **Domain:** Frontend (FE-014)
- **Remediation:** Align values in manifest.json and layout.tsx

### FIX-047: Manifest references non-existent screenshots/icons
- **Domain:** Frontend (FE-016)
- **Remediation:** Create assets or remove references

### FIX-048: DNS-prefetch to GTM before cookie consent
- **Domain:** Frontend (FE-024)
- **File:** `app/layout.tsx:78`
- **Remediation:** Remove if GTM not used, or verify consent gate

### FIX-049: Privacy page URL confusion (/privacy vs /privacy-policy)
- **Domain:** Frontend (FE-019)
- **Remediation:** Consolidate to single canonical URL

---

## LOW

### FIX-050: HTML sanitization fallback uses regex (SEC-015)
### FIX-051: Rate limiter fails open when Redis unavailable (SEC-016)
### FIX-052: User email in redirect URL (SEC-017)
### FIX-053: Smoke test credentials in .env.local (SEC-018)
### FIX-054: DB errors forwarded in admin health response (SEC-019)
### FIX-055: founding_member_counter readable by anon (DB-011)
### FIX-056: created_at nullable across all tables (DB-012)
### FIX-057: Wildcard in image remotePatterns (PERF-014)
### FIX-058: Image minimumCacheTTL only 60s (PERF-015)
### FIX-059: Feature pages missing metadata exports (FE-004)
### FIX-060: Modal backdrop aria-label should be aria-hidden (FE-007)
### FIX-061: Duplicate CSS classes in ConfirmDialog (FE-011)
### FIX-062: Missing loading.tsx for year-in-review (FE-013)
### FIX-063: Manifest icon sizes claim different sizes for same file (FE-017)
### FIX-064: Copyright year 2025 (FE-022)
### FIX-065: Tables with min-width may cause horizontal scroll (FE-026)
### FIX-066: aria-live limited to only 2 components (FE-005)

---

## Checks Performed

### Security (12 categories)
- [x] Dependency vulnerabilities (3 CVEs found)
- [x] Secrets detection (1 duplicate found)
- [x] Injection (SQL, XSS, command, path traversal, SSRF)
- [x] Authentication & authorization (163 API routes audited)
- [x] API security (rate limiting, input validation, CORS)
- [x] Security headers (CSP, HSTS, X-Frame, etc.)
- [x] Environment & configuration
- [x] Cryptography
- [x] Client-side security
- [x] Error handling & info disclosure
- [x] Business logic (race conditions, IDOR, privilege escalation)
- [x] Webhook security

### Database (7 categories)
- [x] RLS enabled on all tables (1 table missing)
- [x] RLS policy quality (472 performance issues, 1 OR-combined risk)
- [x] Function security (1 missing search_path)
- [x] Index coverage (all FKs indexed, 395 unused indexes)
- [x] Schema isolation
- [x] Data integrity (nullable space_id, missing CHECK constraints)
- [x] Supabase advisors (security + performance)

### Performance (9 categories)
- [x] Bundle analysis (3 pages > 450kB)
- [x] Memory leaks (2 minor, properly bounded)
- [x] Unbounded queries (280 .select('*'))
- [x] Image optimization (well configured)
- [x] Caching strategy (React Query excellent)
- [x] Serverless configuration (missing maxDuration)
- [x] API design (4 N+1 patterns, sequential crons)
- [x] Middleware performance (DB call per request)
- [x] React performance (no React.memo usage)

### Frontend/UX (10 categories)
- [x] SEO (missing robots.txt, metadataBase, OG images)
- [x] Accessibility (good baseline, 2 improvements needed)
- [x] HTML validity (3 minor issues)
- [x] Error handling & loading states (comprehensive)
- [x] PWA & manifest (icon/screenshot references broken)
- [x] Navigation & routing (auth gaps, URL confusion)
- [x] Design consistency (dark mode fully implemented)
- [x] Cookie & privacy compliance (thorough)
- [x] Forms & interactions (well implemented)
- [x] Mobile responsiveness (good)

---

## Positive Findings

- All 163 API routes have authentication checks
- Webhook HMAC-SHA256 with timing-safe comparison
- CSRF double-submit cookie with timing-safe comparison
- AES-256-GCM admin session encryption
- SSRF protection on ICS imports
- No service_role key in client code
- .env.local never committed to git
- Source maps hidden in production
- DOMPurify HTML sanitization
- All FK columns indexed
- React Query well-configured (staleTime, offlineFirst, backoff)
- ISR on static pages
- Dark mode cleanup complete (zero light mode code)
- Comprehensive error boundary coverage
- Full GDPR/CCPA privacy infrastructure
- Modal focus trap, keyboard dismiss
- 31 loading.tsx routes
- Proper viewport and touch target configuration

---

## Next Steps

1. Run `/sec-fix FIX-001` through `/sec-fix FIX-004` to fix critical issues
2. Run `/sec-fix FIX-021` to add missing auth protection (security gap)
3. Run `/sec-fix FIX-015` to add maxDuration to crons
4. Review and test changes
5. Run `/gh-feat` to push fixes

---

*Generated by Claude Production Audit (4-domain sweep)*
