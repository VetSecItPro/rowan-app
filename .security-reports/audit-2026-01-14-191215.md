# Security Audit Report

**Date:** 2026-01-14 17:30:00
**Project:** rowan-app
**Audited by:** Claude Security Audit

---

## Executive Summary

| Severity | Count |
|----------|-------|
| üî¥ Critical | 1 |
| üü† High | 4 |
| üü° Medium | 5 |
| üü¢ Low | 2 |
| ‚ÑπÔ∏è Info | 3 |
| ‚úÖ Auto-fixed | 0 |

**Overall Risk Level:** HIGH

---

## Auto-Fixed Issues

No issues were auto-fixed in this audit. The critical jspdf vulnerability requires a breaking change upgrade that should be manually reviewed.

---

## Outstanding Issues Requiring Manual Review

### üî¥ Critical

#### FIX-001: jsPDF Local File Inclusion/Path Traversal Vulnerability
- **File:** `package.json`
- **Category:** Dependencies
- **Description:** jsPDF version <=3.0.4 has a Local File Inclusion/Path Traversal vulnerability (GHSA-f8cm-6447-x5h2) that could allow attackers to access files outside intended directories.
- **Code:**
  ```json
  "jspdf": "^3.0.3"
  ```
- **Remediation:** Update to jspdf@4.0.0 (breaking change). Test PDF generation functionality after upgrade.
- **Command:** `npm audit fix --force`

---

### üü† High

#### FIX-002: Overly Permissive RLS Policy on active_chat_prompt
- **File:** Supabase Database
- **Category:** RLS Policy
- **Description:** Table `public.active_chat_prompt` has an RLS policy `Allow authenticated update chat prompt` for UPDATE that allows unrestricted access (USING(true) and WITH CHECK(true)). Any authenticated user can modify the chat prompt configuration.
- **Remediation:** Restrict the policy to admin users only.
- **Suggested Fix:**
  ```sql
  ALTER POLICY "Allow authenticated update chat prompt" ON active_chat_prompt 
  USING (EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND is_admin = true));
  ```

#### FIX-003: Overly Permissive RLS Policy on active_summarizer_prompt
- **File:** Supabase Database
- **Category:** RLS Policy
- **Description:** Table `public.active_summarizer_prompt` has an RLS policy `Allow authenticated modify summarizer prompt` for ALL operations that allows unrestricted access. This effectively bypasses row-level security for authenticated users.
- **Remediation:** Restrict the policy to admin users only.
- **Suggested Fix:**
  ```sql
  ALTER POLICY "Allow authenticated modify summarizer prompt" ON active_summarizer_prompt 
  USING (EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND is_admin = true));
  ```

#### FIX-004: OTP Expiry Time Too Long
- **File:** Supabase Auth Configuration
- **Category:** Authentication
- **Description:** The email provider OTP expiry is set to more than 1 hour. Long OTP validity windows increase the risk of OTP interception and reuse attacks.
- **Remediation:** Set OTP expiry to less than 1 hour in Supabase Dashboard > Authentication > Email
- **Reference:** https://supabase.com/docs/guides/platform/going-into-prod#security

#### FIX-005: Leaked Password Protection Disabled
- **File:** Supabase Auth Configuration
- **Category:** Authentication
- **Description:** Supabase Auth's leaked password protection feature is disabled. This feature checks passwords against the HaveIBeenPwned database to prevent use of compromised passwords.
- **Remediation:** Enable leaked password protection in Supabase Dashboard > Authentication > Password Security
- **Reference:** https://supabase.com/docs/guides/auth/password-security#password-strength-and-leaked-password-protection

---

### üü° Medium

#### FIX-006: PostgreSQL Security Patches Available
- **File:** Supabase Infrastructure
- **Category:** Database
- **Description:** The current PostgreSQL version (supabase-postgres-17.4.1.041) has outstanding security patches available.
- **Remediation:** Upgrade PostgreSQL via Supabase Dashboard.
- **Reference:** https://supabase.com/docs/guides/platform/upgrading

#### FIX-007: Permissive INSERT Policy on api_usage
- **File:** Supabase Database
- **Category:** RLS Policy
- **Description:** Table `public.api_usage` has an INSERT policy `System can insert api_usage` that allows unrestricted inserts (WITH CHECK(true)).
- **Remediation:** Consider restricting to service_role or adding specific conditions if this table should not be directly writable by regular authenticated users.

#### FIX-008: Permissive INSERT Policy on processing_metrics
- **File:** Supabase Database
- **Category:** RLS Policy
- **Description:** Table `public.processing_metrics` has an INSERT policy `System can insert processing_metrics` that allows unrestricted inserts.
- **Remediation:** Consider restricting to service_role or adding specific conditions.

#### FIX-009: Insecure Random Number Generation
- **File:** Multiple files
- **Category:** Cryptography
- **Description:** `Math.random()` is used in multiple locations for generating IDs, session tokens, and filenames. Math.random() is not cryptographically secure.
- **Affected Files:**
  - `lib/hooks/useFeatureTracking.ts:77`
  - `lib/hooks/useOfflineQueue.ts:159`
  - `lib/services/receipts-service.ts:81`
  - `lib/services/storage-service.ts:73`
  - And others
- **Remediation:** Replace with `crypto.randomUUID()` for IDs or `crypto.getRandomValues()` for security-sensitive random values.

#### FIX-010: Some API Routes Missing Input Validation
- **File:** `app/api/`
- **Category:** API Security
- **Description:** While 78 API routes have Zod validation (`.parse()` or `.safeParse()`), approximately 73 routes lack explicit schema validation.
- **Remediation:** Add Zod schema validation to all API routes that accept user input.
- **Example:**
  ```typescript
  import { z } from 'zod';
  const schema = z.object({ name: z.string().min(1) });
  const result = schema.safeParse(body);
  if (!result.success) return NextResponse.json({ error: 'Invalid input' }, { status: 400 });
  ```

---

### üü¢ Low

#### FIX-011: .env.local File Present
- **File:** `.env.local`
- **Category:** Environment
- **Description:** A `.env.local` file is present in the repository directory. While `.gitignore` includes `.env.local`, verify it is not tracked in git.
- **Remediation:** Run `git status .env.local` to verify it is not tracked.

#### FIX-012: Security Headers Disabled in Development
- **File:** `next.config.mjs:104`
- **Category:** Security Headers
- **Description:** All security headers including CSP are disabled in development mode (`if (process.env.NODE_ENV === 'development') { return []; }`).
- **Remediation:** Consider enabling at least basic security headers in development for testing security issues earlier.

---

### ‚ÑπÔ∏è Info

#### FIX-013: CSP Uses unsafe-inline and unsafe-eval
- **File:** `next.config.mjs:120`
- **Category:** Security Headers
- **Description:** Content Security Policy includes `'unsafe-inline'` and `'unsafe-eval'` directives. This is documented in the config as necessary for Next.js framework limitations.
- **Note:** This is a known Next.js limitation. Consider implementing nonce-based CSP when Next.js nonce support stabilizes.

#### FIX-014: Service Role Key Usage in Server Code
- **File:** Multiple server files
- **Category:** API Security
- **Description:** `SUPABASE_SERVICE_ROLE_KEY` is used in server-side code for admin operations. This is acceptable but should be audited.
- **Locations:**
  - `app/api/auth/cleanup-orphaned-user/route.ts`
  - `app/api/messages/mark-conversation-read/route.ts`
  - `app/api/admin/logs/route.ts`
  - `lib/supabase-server.ts`
  - `lib/supabase/admin.ts`

#### FIX-015: Console.log Statements in Production Code
- **File:** `lib/`, `components/`
- **Category:** Logging
- **Description:** Found ~14 console.log statements across lib/ and components/ directories. Production builds strip these via the compiler config in `next.config.mjs`.
- **Note:** This is handled by the production build but consider removing for cleaner code.

---

## Checks Performed

- [x] Dependency vulnerabilities (npm audit)
- [x] Secrets detection (no hardcoded secrets found)
- [x] SQL/XSS/Command injection (no direct vulnerabilities found)
- [x] Authentication & authorization (151 routes have auth checks)
- [x] Supabase RLS policies (all tables have RLS enabled)
- [x] API rate limiting (149 routes have rate limiting)
- [x] Input validation (78 routes use Zod)
- [x] Security headers (comprehensive in production)
- [x] Environment configuration
- [x] Cryptography (Math.random usage flagged)
- [x] Client-side security
- [x] Data privacy (no PII in logs)
- [x] React/Next.js specific
- [x] Error handling
- [x] Business logic

---

## Positive Security Findings

‚úÖ **No hardcoded secrets found** - All secrets use environment variables
‚úÖ **All tables have RLS enabled** - Row-level security is enforced
‚úÖ **Comprehensive security headers in production** - CSP, HSTS, X-Frame-Options, etc.
‚úÖ **Rate limiting widely implemented** - 149/151 API routes have rate limiting
‚úÖ **DOMPurify integrated** - XSS protection for user content
‚úÖ **No eval() or new Function() usage** - Safe from code injection
‚úÖ **No child_process/spawn usage** - Safe from command injection
‚úÖ **Production console stripping** - Debug info removed in production
‚úÖ **.gitignore properly configured** - .env files excluded

---

## Next Steps

1. **CRITICAL:** Run `/sec-fix FIX-001` to upgrade jspdf (test PDF functionality after)
2. **HIGH:** Fix RLS policies FIX-002 and FIX-003 in Supabase Dashboard
3. **HIGH:** Configure auth settings FIX-004 and FIX-005 in Supabase Dashboard
4. **MEDIUM:** Upgrade PostgreSQL via Supabase Dashboard (FIX-006)
5. Review and test changes
6. Run `/gh-feat` to push security fixes

---

*Generated by Claude Security Audit*
